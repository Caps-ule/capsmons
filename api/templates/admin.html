<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>CapsMons ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111826;
      --panel2:#0f1623;
      --text:#e6edf3;
      --muted:#9aa4b2;
      --border:#233044;
      --tableHead:#0e1522;
      --link:#7aa2ff;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:14px;

      --ok:#2bd576;
      --off:#4a5568;
    }
    [data-theme="light"]{
      --bg:#ffffff;
      --panel:#ffffff;
      --panel2:#f7f7f9;
      --text:#101418;
      --muted:#5b6777;
      --border:#e6e8ec;
      --tableHead:#f2f4f7;
      --link:#0b57d0;
      --shadow:0 10px 24px rgba(0,0,0,.08);

      --ok:#0a7a2f;
      --off:#94a3b8;
    }

    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:24px;
      max-width:1100px;
      background:var(--bg);
      color:var(--text);
    }

    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    h1{margin:0 0 6px; font-size:28px}
    h2{margin:22px 0 10px; font-size:18px}

    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}

    input,button{
      padding:10px 12px;
      font-size:14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
    }
    button{cursor:pointer}
    button:hover{filter:brightness(1.08)}

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin-top:16px;
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      box-shadow:var(--shadow);
    }

    table{
      border-collapse:collapse;
      width:100%;
      margin-top:16px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--border);
    }
    th,td{border-bottom:1px solid var(--border); padding:10px; text-align:left; vertical-align:middle}
    th{
      background:var(--tableHead);
      color:var(--muted);
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    tr:last-child td{border-bottom:none}

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }

    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
    }
    .toggle input{transform:scale(1.1)}

    /* Live buttons */
    .liveRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:none;
      border-radius:10px;
      padding:8px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .btnLive{ background:var(--ok); color:#07130c; }
    .btnOff{ background:var(--off); color:#0b0f14; }
    .btnDisabled{ opacity:.45; cursor:not-allowed; }

    .badge{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      color:var(--text);
    }
    [data-theme="light"] .badge{
      border:1px solid rgba(0,0,0,.12);
      background:rgba(0,0,0,.04);
    }

    .navlinks a{margin-right:14px}
    .navlinks a:last-child{margin-right:0}
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>CapsMons ‚Äî Admin</h1>
      <div class="muted">Prot√©g√© par HTTP Basic (MVP). URL: <b>/admin</b></div>
    </div>

    <div class="row">
      <a href="/admin/stats">üìä Stats</a>

      <div class="toggle">
        <input type="checkbox" id="themeToggle" checked>
        <label for="themeToggle">Dark mode</label>
      </div>

      <div class="liveRow">
        <button class="btn btnLive {% if is_live %}btnDisabled{% endif %}" onclick="setLive(true)">üü¢ Live</button>
        <button class="btn btnOff {% if not is_live %}btnDisabled{% endif %}" onclick="setLive(false)">‚ö´ Off Live</button>


        <span class="badge">
          √âtat : <b>{% if is_live %}LIVE{% else %}OFFLINE{% endif %}</b>
        </span>
      </div>
    </div>
  </div>

  <div class="card">
    <form method="get" action="/admin" class="row" style="margin:0 0 10px;">
      <label for="q">Rechercher un viewer :</label>
      <input id="q" type="text" name="q" placeholder="pseudo twitch (ex: capsloque)" value="{{ q or '' }}">
      <button type="submit">Rechercher</button>
    </form>

    <div class="navlinks muted">
      <a href="/admin/stats">üìä Stats</a>
      <a href="/admin/cms">üß¨ CM & Pool</a>
      <a href="/admin/rp">üìù RP</a>
      <a href="/admin/forms">üß¨ Forms</a>
    </div>

    <div style="margin-top:10px">
      {% if q and result %}
      <div>
        R√©sultat :
        <a href="/admin/user/{{ result.twitch_login }}">{{ result.twitch_login }}</a>
        ‚Äî {{ result.xp_total }} XP ‚Äî stage {{ result.stage }}
      </div>
      {% elif q and not result %}
      <div>Aucun r√©sultat pour ‚Äú{{ q }}‚Äù.</div>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">üéÅ Auto Drop</h2>
    <div class="muted" style="margin-bottom:12px;">
      Configure les drops automatiques (stock√© en BDD, pas dans le .env).
    </div>

    <div class="row" style="align-items:flex-end;">
      <label class="row" style="gap:8px;">
        <input type="checkbox" id="ad_enabled">
        <span>Activ√©</span>
      </label>

      <div>
        <div class="muted">D√©lai min (s)</div>
        <input id="ad_min" type="number" min="60" value="900" style="width:120px">
      </div>
      <div>
        <div class="muted">D√©lai max (s)</div>
        <input id="ad_max" type="number" min="60" value="1500" style="width:120px">
      </div>

      <div>
        <div class="muted">Dur√©e min (s)</div>
        <input id="ad_dmin" type="number" min="5" value="10" style="width:120px">
      </div>
      <div>
        <div class="muted">Dur√©e max (s)</div>
        <input id="ad_dmax" type="number" min="5" value="20" style="width:120px">
      </div>

      <div>
        <div class="muted">Type</div>
        <select id="ad_kind" style="padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);">
          <option value="any">any</option>
          <option value="xp">xp</option>
          <option value="candy">candy</option>
          <option value="egg">egg</option>
        </select>
      </div>

      <div>
        <div class="muted">Mode</div>
        <select id="ad_mode" style="padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);">
          <option value="random">random</option>
          <option value="first">first</option>
        </select>
      </div>

      <div>
        <div class="muted">Qty</div>
        <input id="ad_qty" type="number" min="1" max="50" value="1" style="width:90px">
      </div>
    </div>

    <div style="margin-top:12px;">
      <div class="muted">Fallback image URL (si item.icon_url vide)</div>
      <input id="ad_fallback" type="text" placeholder="https://..." style="width:100%;max-width:780px">
    </div>

    <div class="row" style="margin-top:14px;">
      <button onclick="saveAutoDrop()">üíæ Enregistrer</button>
      <button onclick="testAutoDrop()">üß™ Test drop maintenant</button>
      <span id="ad_status" class="muted"></span>
    </div>
  </div>
  <h2>üë• Viewers</h2>

  <div class="muted">
    {{ total_users }} viewer(s) ‚Äî page {{ page }} / {{ total_pages }}
  </div>

  <table>
    <thead>
      <tr>
        <th>Viewer</th>
        <th>CM</th>
        <th>XP Total</th>
        <th>Stage max</th>
        <th>Actif</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td><a href="/admin/user/{{ u.twitch_login }}">{{ u.twitch_login }}</a></td>
        <td>{{ u.cm_count }}</td>
        <td>{{ u.xp_total_sum }}</td>
        <td>{{ u.stage_max }}</td>
        <td>{% if u.active_id %}#{{ u.active_id }}{% else %}‚Äî{% endif %}</td>
        <td>
          <a href="/admin/user/{{ u.twitch_login }}">Ouvrir</a>
          ¬∑
          <a href="/admin/user/{{ u.twitch_login }}/collection">Collection</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="row" style="margin-top:12px;">
    {% set base = '/admin?per=' ~ per ~ (q and ('&q=' ~ q) or '') %}
    <a href="{{ base }}&page=1">‚èÆÔ∏è D√©but</a>
    <a href="{{ base }}&page={{ (page-1) if page>1 else 1 }}">‚¨ÖÔ∏è Pr√©c√©dent</a>
    <span class="muted">Page {{ page }} / {{ total_pages }}</span>
    <a href="{{ base }}&page={{ (page+1) if page<total_pages else total_pages }}">Suivant ‚û°Ô∏è</a>
      <a href="{{ base }}&page={{ total_pages }}">Fin ‚è≠Ô∏è</a>
    </div>


    <h2>Top XP</h2>
    <table>
      <thead>
        <tr>
          <th>Viewer</th>
          <th>XP</th>
          <th>Stage</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in top %}
        <tr>
          <td><a href="/admin/user/{{ u.twitch_login }}">{{ u.twitch_login }}</a></td>
          <td>{{ u.xp_total }}</td>
          <td>{{ u.stage }}</td>
          <td><a href="/admin/user/{{ u.twitch_login }}">Ouvrir</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <script>
      (function () {
        const KEY = "capsmons_theme";
        const toggle = document.getElementById("themeToggle");

        function apply(theme) {
          document.documentElement.setAttribute("data-theme", theme);
          toggle.checked = (theme !== "light");
        }

        const saved = localStorage.getItem(KEY);
        apply(saved || "dark");

        toggle.addEventListener("change", () => {
          const theme = toggle.checked ? "dark" : "light";
          localStorage.setItem(KEY, theme);
          apply(theme);
        });
      })();

      async function setLive(v){
        const r = await fetch('/admin/set_live', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({value: v})
        });
        const j = await r.json();
        if(!r.ok) alert(JSON.stringify(j));
        else location.reload();
      }


      async function loadAutoDrop(){
        const el = (id)=>document.getElementById(id);
        const r = await fetch('/admin/autodrop');
        const j = await r.json();
        if(!r.ok){ el('ad_status').textContent = "Erreur chargement AutoDrop"; return; }

        const s = j.settings || {};
        el('ad_enabled').checked = (String(s.auto_drop_enabled||"false") === "true");
        el('ad_min').value = s.auto_drop_min_seconds || 900;
        el('ad_max').value = s.auto_drop_max_seconds || 1500;
        el('ad_dmin').value = s.auto_drop_duration_min_seconds || 10;
        el('ad_dmax').value = s.auto_drop_duration_max_seconds || 20;
        el('ad_kind').value = s.auto_drop_pick_kind || "any";
        el('ad_mode').value = s.auto_drop_mode || "random";
        el('ad_qty').value = s.auto_drop_ticket_qty || 1;
        el('ad_fallback').value = s.auto_drop_fallback_media_url || "";
        el('ad_status').textContent = "";
      }

      async function saveAutoDrop(){
        const el = (id)=>document.getElementById(id);

        const payload = {
          enabled: el('ad_enabled').checked,
          min_seconds: el('ad_min').value,
          max_seconds: el('ad_max').value,
          duration_min: el('ad_dmin').value,
          duration_max: el('ad_dmax').value,
          pick_kind: el('ad_kind').value,
          mode: el('ad_mode').value,
          ticket_qty: el('ad_qty').value,
          fallback_media_url: el('ad_fallback').value
        };

        const r = await fetch('/admin/autodrop/save', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        el('ad_status').textContent = r.ok ? "‚úÖ Enregistr√©" : ("‚õî " + JSON.stringify(j));
      }

      async function testAutoDrop(){
        const el = (id)=>document.getElementById(id);
        el('ad_status').textContent = "Test...";
        const r = await fetch('/admin/autodrop/test', {method:'POST'});
        const j = await r.json();
        if(!r.ok){
          el('ad_status').textContent = "‚õî " + JSON.stringify(j);
          return;
        }
        const p = j.picked || {};
        el('ad_status').textContent = `‚úÖ Drop lanc√©: ${p.item_name || p.item_key || "?"}`;
      }

      loadAutoDrop();


    </script>
  </body>
  </html>
