<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>CapsMons ‚Äî Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#0b0f14;
    --panel:#111826;
    --panel2:#0f1623;
    --text:#e6edf3;
    --muted:#9aa4b2;
    --border:#233044;
    --tableHead:#0e1522;
    --barBg:#1a2636;
    --barFill:#7aa2ff;
    --link:#7aa2ff;
    --ok:#2bd576;
    --err:#ff5c5c;
    --shadow: 0 12px 30px rgba(0,0,0,.35);
    --radius: 14px;
  }

  /* Light theme overrides */
  [data-theme="light"]{
    --bg:#ffffff;
    --panel:#ffffff;
    --panel2:#f7f7f9;
    --text:#101418;
    --muted:#5b6777;
    --border:#e6e8ec;
    --tableHead:#f2f4f7;
    --barBg:#e9eef7;
    --barFill:#2f6fed;
    --link:#0b57d0;
    --shadow: 0 10px 24px rgba(0,0,0,.08);
  }

  *{box-sizing:border-box}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    margin:24px;
    max-width:1100px;
    background:var(--bg);
    color:var(--text);
  }

  a{color:var(--link); text-decoration:none}
  a:hover{text-decoration:underline}

  h1{margin:0 0 12px; font-size:28px}
  h2{margin:22px 0 10px; font-size:18px}

  .muted{color:var(--muted); font-size:13px}

  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px; margin-top:12px}

  .card{
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    background:linear-gradient(180deg, var(--panel), var(--panel2));
    box-shadow:var(--shadow);
  }

  table{border-collapse:collapse; width:100%; overflow:hidden; border-radius:12px; border:1px solid var(--border)}
  th,td{border-bottom:1px solid var(--border); padding:10px; text-align:left}
  th{background:var(--tableHead); color:var(--muted); font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing:.04em}
  tr:last-child td{border-bottom:none}

  .kpi{
    font-size:30px;
    font-weight:800;
    line-height:1.1;
    margin-top:6px;
  }

  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}

  button{
    padding:10px 12px;
    font-size:14px;
    cursor:pointer;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--panel);
    color:var(--text);
  }
  button:hover{filter:brightness(1.08)}

  .toggle{
    display:flex; gap:8px; align-items:center;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--panel);
  }
  .toggle input{transform:scale(1.1)}

  .barWrap{flex:1; background:var(--barBg); border-radius:999px; overflow:hidden; height:14px; border:1px solid var(--border)}
  .barFill{height:14px; background:linear-gradient(90deg, var(--barFill), rgba(122,162,255,.6))}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
</style>

</head>
<body>
  <p><a href="/admin">‚Üê Retour admin</a></p>
  <h1>üìä Stats CapsMons</h1>
<div class="card" style="margin-top:12px">
  <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
    <label style="display:flex; gap:8px; align-items:center">
      <input type="checkbox" id="autoRefresh" checked>
      Auto-refresh (30s)
    </label>
    <div class="muted" id="nextRefresh"></div>
    <button id="refreshNow" type="button">Rafra√Æchir maintenant</button>
  </div>
</div>

<script>
  (function () {
    const CHECK_KEY = "capsmons_auto_refresh";
    const INTERVAL_MS = 30000;

    const cb = document.getElementById("autoRefresh");
    const next = document.getElementById("nextRefresh");
    const btn = document.getElementById("refreshNow");

    // restore
    const saved = localStorage.getItem(CHECK_KEY);
    if (saved === "0") cb.checked = false;

    btn.addEventListener("click", () => location.reload());

    let timer = null;
    let deadline = null;

    function formatTime(d) {
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function stop() {
      if (timer) clearInterval(timer);
      timer = null;
      deadline = null;
      next.textContent = "Auto-refresh d√©sactiv√©.";
    }

    function start() {
      deadline = new Date(Date.now() + INTERVAL_MS);
      next.textContent = "Prochain rafra√Æchissement √† " + formatTime(deadline) + ".";
      timer = setInterval(() => {
        if (!cb.checked) return;
        location.reload();
      }, INTERVAL_MS);
    }

    cb.addEventListener("change", () => {
      localStorage.setItem(CHECK_KEY, cb.checked ? "1" : "0");
      if (cb.checked) {
        start();
      } else {
        stop();
      }
    });

    if (cb.checked) start();
    else stop();
  })();
</script>

  <div class="muted">P√©riodes bas√©es sur l‚Äôhorodatage des events (UTC).</div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <div class="muted">XP aujourd‚Äôhui</div>
      <div style="font-size:28px; font-weight:700">{{ xp_today }}</div>
    </div>
    <div class="card">
      <div class="muted">XP 7 jours</div>
      <div style="font-size:28px; font-weight:700">{{ xp_7d }}</div>
    </div>
    <div class="card">
      <div class="muted">Events 24h</div>
      <div style="font-size:28px; font-weight:700">{{ events_24h }}</div>
    </div>
    <div class="card">
      <div class="muted">Viewers actifs 24h</div>
      <div style="font-size:28px; font-weight:700">{{ active_users_24h }}</div>
    </div>
    <div class="card">
      <div class="muted">Viewers actifs (15 min)</div>
      <div style="font-size:28px; font-weight:700">{{ active_users_15m }}</div>
    </div>
  </div>

  <h2>XP par jour (7 derniers jours)</h2>
  <div class="card">
  {% for row in xp_by_day %}
    <div style="display:flex; gap:10px; align-items:center; margin:8px 0">
      <div style="width:110px; class=mono">{{ row.day }}</div>
      <div class="barWrap">
        <div class="barFill" style="width: {{ row.pct }}%"></div>
      </div>

      <div style="width:80px; text-align:right">{{ row.xp }}</div>
    </div>
  {% endfor %}
</div>

   <table>
    <thead>
      <tr><th>Jour</th><th>XP</th></tr>
    </thead>
    <tbody>
      {% for row in xp_by_day %}
      <tr><td>{{ row.day }}</td><td>{{ row.xp }}</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <h2>Top XP (24h)</h2>
  <table>
    <thead>
      <tr><th>Viewer</th><th>XP</th></tr>
    </thead>
    <tbody>
      {% for row in top_xp_24h %}
      <tr>
        <td><a href="/admin/user/{{ row.twitch_login }}">{{ row.twitch_login }}</a></td>
        <td>{{ row.xp }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h2>Top activit√© (24h)</h2>
  <table>
    <thead>
      <tr><th>Viewer</th><th>Events</th></tr>
    </thead>
    <tbody>
      {% for row in top_events_24h %}
      <tr>
        <td><a href="/admin/user/{{ row.twitch_login }}">{{ row.twitch_login }}</a></td>
        <td>{{ row.events }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
<script>
  (function () {
    const KEY = "capsmons_theme";
    const toggle = document.getElementById("themeToggle");

    function apply(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      toggle.checked = (theme !== "light");
    }

    const saved = localStorage.getItem(KEY);
    if (saved) apply(saved);
    else apply("dark");

    toggle.addEventListener("change", () => {
      const theme = toggle.checked ? "dark" : "light";
      localStorage.setItem(KEY, theme);
      apply(theme);
    });
  })();
</script>

</body>
</html>
